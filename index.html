<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cek Piutang PT. Putra Citanusa</title>
<style>
  body{
    font-family: Arial, sans-serif;
    background:#f0f2f5;
    display:flex;
    flex-direction:column;
    align-items:center;
    padding:20px;
  }
  h1{
    color:#1877f2;
    margin-bottom:20px;
  }
  .form-box{
    background:#fff;
    padding:20px;
    border-radius:8px;
    box-shadow:0 2px 6px rgba(0,0,0,0.2);
    width:320px;
  }
  .form-group{
    margin-bottom:15px;
  }
  .form-group input{
    width:100%;
    padding:10px;
    border:1px solid #ccc;
    border-radius:5px;
    box-sizing:border-box;
    font-size:14px;
  }
  .form-group input::placeholder{
    color:#888;
  }
  .btn{
    display:block;
    margin:0 auto;
    background:#1877f2;
    color:#fff;
    padding:8px 0;
    width:50%;
    border:none;
    border-radius:5px;
    cursor:pointer;
    font-size:16px;
    text-align:center;
  }
  .btn:hover{background:#166fe5;}

  table{
    border-collapse:collapse;
    width:100%;
    margin-top:20px;
    background:#fff;
  }
  th, td{
    border:1px solid #ccc;
    padding:6px;
    text-align:left;
    font-size:14px;
  }
  th{
    background:#1877f2; /* warna header sama dengan PDF */
    color:#fff;
  }
  #downloadBtn{
    margin-top:15px;
    padding:8px 20px;
    background:#1877f2;
    color:#fff;
    border:none;
    border-radius:5px;
    cursor:pointer;
    display:none;
  }
  #downloadBtn:hover{background:#166fe5;}

  #backBtn{
    margin-top:20px;
    padding:8px 20px;
    background:#1877f2;
    color:#fff;
    border:none;
    border-radius:5px;
    cursor:pointer;
    display:none;
  }

  footer{
    position:fixed;
    bottom:10px;
    left:0;
    width:100%;
    text-align:center;
    color:#555;
    font-size:14px;
  }
</style>
</head>
<body>

<h1>Cek Piutang</h1>

<div class="form-box" id="searchForm">
  <div class="form-group">
    <input type="text" id="lokasi" placeholder="Lokasi">
  </div>
  <div class="form-group">
    <input type="number" id="tahun" placeholder="Tahun">
  </div>
  <div class="form-group">
    <input type="password" id="password" placeholder="Password">
  </div>
  <button class="btn" onclick="cariData()">Cari</button>
</div>

<div id="resultContainer" style="width:100%; max-width:1000px;"></div>
<button id="downloadBtn" onclick="downloadPDF()">Download PDF</button>
<button id="backBtn" onclick="kembali()">Kembali</button>

<footer>PT. Putra Citanusa @ 2025</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script>
const { jsPDF } = window.jspdf;

// ==== Ganti URL berikut dengan URL publik Google Sheets JSON/CSV yang sudah disiapkan ====
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT-PAf-G7kujpAjGhWROCvIrQ2gxn4MPjiCdbmYeowwjox00VKu2mq5cVFkgSUNg91tzJXfPHF34np7/pub?gid=126462838&single=true&output=tsv";

async function fetchData() {
  const res = await fetch(SHEET_URL);
  const data = await res.json();
  // Pastikan parsing sesuai format Anda
  return data;
}

async function cariData(){
  const lokasi = document.getElementById('lokasi').value.trim();
  const tahun  = document.getElementById('tahun').value.trim();
  const password = document.getElementById('password').value.trim();

  if(!lokasi || !tahun || !password){
    alert('Isi semua kolom.');
    return;
  }

  const rows = await fetchData();

  // filter lokasi, tahun dan password (atau master password)
  const hasil = rows.filter(r=>{
    const tglFaktur = r['Tgl Faktur'] || '';
    const th = tglFaktur.slice(-4);
    return r['No. Pelanggan']===lokasi &&
           th===tahun &&
           (r['Password']===password || password==="master123");
  });

  const container = document.getElementById('resultContainer');
  container.innerHTML = '';

  if(hasil.length===0){
    alert("Data tidak ditemukan");
    return;
  }

  // sembunyikan form, tampilkan tombol kembali
  document.getElementById('searchForm').style.display='none';
  document.getElementById('backBtn').style.display='inline-block';
  document.getElementById('downloadBtn').style.display='inline-block';

  let total=0;
  const table = document.createElement('table');
  const thead = document.createElement('thead');
  thead.innerHTML = `
    <tr>
      <th>No</th>
      <th>No. Faktur</th>
      <th>Tgl Faktur</th>
      <th>No. Pelanggan</th>
      <th>Nama Pelanggan</th>
      <th>Nilai Faktur</th>
      <th>Terutang</th>
      <th>Tanggal Bayar</th>
      <th>Keterangan</th>
    </tr>`;
  table.appendChild(thead);

  const tbody = document.createElement('tbody');
  hasil.forEach((r,i)=>{
    total += Number(r['Nilai Faktur']||0);
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${i+1}</td>
      <td>${r['No. Faktur']||''}</td>
      <td>${r['Tgl Faktur']||''}</td>
      <td>${r['No. Pelanggan']||''}</td>
      <td>${r['Nama Pelanggan']||''}</td>
      <td>${r['Nilai Faktur']||0}</td>
      <td>${r['Terutang']||0}</td>
      <td>${r['Tanggal Bayar']||''}</td>
      <td>${r['Keterangan']||''}</td>`;
    tbody.appendChild(row);
  });
  // total baris
  const totalRow = document.createElement('tr');
  totalRow.innerHTML = `<td colspan="5"><b>Total Piutang</b></td>
                        <td><b>${total}</b></td>
                        <td colspan="3"></td>`;
  tbody.appendChild(totalRow);
  table.appendChild(tbody);
  container.appendChild(table);
}

function kembali(){
  document.getElementById('searchForm').style.display='block';
  document.getElementById('resultContainer').innerHTML='';
  document.getElementById('downloadBtn').style.display='none';
  document.getElementById('backBtn').style.display='none';
}

function downloadPDF(){
  const doc = new jsPDF({orientation:'landscape'});
  const dateStr = new Date().toLocaleDateString('id-ID',
                 {day:'2-digit', month:'long', year:'numeric'});
  doc.setFontSize(12);
  doc.text(`Dicetak pada tanggal ${dateStr}`, 250, 15, {align:'right'});

  doc.autoTable({
    html: '#resultContainer table',
    startY: 25,
    headStyles: {fillColor: [24,119,242]}, // sama seperti header web
    styles: {fontSize:12}
  });
  doc.save('laporan-piutang.pdf');
}
</script>
</body>
</html>
