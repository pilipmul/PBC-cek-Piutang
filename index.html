<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Index AR PBC</title>
<link rel="icon" type="image/png" href="Logo CN.png">
<style>
  body { font-family: Arial, sans-serif; background: #f0f2f5; margin: 0; padding: 0; }
  
  #filterForm {
    background: #fff; max-width: 360px; margin: 60px auto; padding: 20px;
    border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    display: flex; flex-direction: column; align-items: center; gap: 12px;
  }
  .input-wrap { position: relative; width: 280px; }
  #filterForm input {
    width: 100%; padding: 10px; border: 1px solid #dddfe2; border-radius: 6px;
    font-size: 14px; box-sizing: border-box; background-color: #fff;
  }

  .custom-dropdown {
    position: absolute; top: 100%; left: 0; right: 0; background: #fff;
    border: 1px solid #dddfe2; border-radius: 0 0 6px 6px; max-height: 200px;
    overflow-y: auto; z-index: 999; display: none; list-style: none; padding: 0;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  .custom-dropdown li { padding: 10px; cursor: pointer; border-bottom: 1px solid #f0f2f5; }
  .custom-dropdown li:hover { background: #f0f2f5; color: #1877f2; }

  table { border-collapse: collapse; width: 100%; background:#fff; font-size: 13px; table-layout: auto; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; position: relative; }
  th { background: #1877f2; color: #fff; padding-right: 25px; user-select: none; cursor: pointer; }
  
  .filter-icon {
    position: absolute; right: 5px; top: 50%; transform: translateY(-50%);
    width: 14px; height: 14px; fill: white;
  }

  .filter-menu {
    position: absolute; top: 100%; left: 0; background: white; color: black;
    border: 1px solid #ccc; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    z-index: 1000; display: none; width: 220px; padding: 10px; border-radius: 4px;
  }
  .filter-menu h4 { margin: 0 0 10px 0; font-size: 12px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
  .filter-menu button {
    display: block; width: 100%; text-align: left; background: none; border: none;
    padding: 8px; cursor: pointer; font-size: 13px;
  }
  .filter-menu button:hover { background: #f0f2f5; }

  .filter-search-box {
    width: 100%; padding: 6px; margin: 5px 0; border: 1px solid #ddd;
    border-radius: 4px; box-sizing: border-box; font-size: 12px;
  }
  .select-all-btn {
    font-size: 11px !important; color: #1877f2; padding: 4px 8px !important;
    text-decoration: underline; background: none; cursor: pointer;
  }

  .checkbox-list { max-height: 150px; overflow-y: auto; margin-top: 5px; border: 1px solid #eee; padding: 5px; }
  .checkbox-item { display: flex; align-items: center; gap: 5px; font-size: 12px; margin-bottom: 4px; }

  #total { margin-top:1em; font-weight: bold; text-align:center; }
  #download, #backBtn { display: none; width: 200px; margin: 10px auto; padding: 12px; border-radius: 6px; color: #fff; cursor: pointer; border:none; font-weight:bold; }
  #download { background: #42b72a; } #backBtn { background: #1877f2; }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>

<h1 style="text-align:center;margin-top:20px;">Index AR PBC</h1>

<form id="filterForm">
  <div class="input-wrap">
    <input type="text" id="lokasi" placeholder="Lokasi (No. Pelanggan)" autocomplete="off" required>
    <ul id="customDropdown" class="custom-dropdown"></ul>
  </div>
  <div class="input-wrap">
    <input type="password" id="password" placeholder="Password" required>
  </div>
  <button type="submit" style="background:#1877f2; color:#fff; border:none; padding:12px; border-radius:6px; cursor:pointer; width:150px; font-weight:bold;">Cari</button>
</form>

<div id="hasilContainer" style="display:none; max-width:98%; margin:auto; overflow-x:auto;">
  <table id="hasilTable">
    <thead>
      <tr id="headerRow">
        <th>No.</th>
        <th data-col="0">No. Faktur <svg class="filter-icon" viewBox="0 0 20 20"><path d="M5 8l5 5 5-5H5z"/></svg></th>
        <th data-col="1">Tgl Faktur <svg class="filter-icon" viewBox="0 0 20 20"><path d="M5 8l5 5 5-5H5z"/></svg></th>
        <th data-col="2">No. Pelanggan <svg class="filter-icon" viewBox="0 0 20 20"><path d="M5 8l5 5 5-5H5z"/></svg></th>
        <th data-col="3">Nama Pelanggan <svg class="filter-icon" viewBox="0 0 20 20"><path d="M5 8l5 5 5-5H5z"/></svg></th>
        <th data-col="4">Nilai Faktur <svg class="filter-icon" viewBox="0 0 20 20"><path d="M5 8l5 5 5-5H5z"/></svg></th>
        <th data-col="5">Terutang <svg class="filter-icon" viewBox="0 0 20 20"><path d="M5 8l5 5 5-5H5z"/></svg></th>
        <th data-col="6">Tanggal Bayar <svg class="filter-icon" viewBox="0 0 20 20"><path d="M5 8l5 5 5-5H5z"/></svg></th>
        <th data-col="7">Keterangan <svg class="filter-icon" viewBox="0 0 20 20"><path d="M5 8l5 5 5-5H5z"/></svg></th>
      </tr>
    </thead>
    <tbody id="hasilBody"></tbody>
  </table>
  <div id="total"></div>
</div>

<div id="filterMenu" class="filter-menu">
  <h4 id="menuTitle">Opsi Kolom</h4>
  <button onclick="execSort('asc')">↑ Sort A to Z</button>
  <button onclick="execSort('desc')">↓ Sort Z to A</button>
  <hr style="border:0; border-top:1px solid #eee; margin:10px 0;">
  <input type="text" id="menuSearch" class="filter-search-box" placeholder="Cari nilai..." onkeyup="searchInMenu()">
  <div style="display:flex; justify-content: space-between;">
    <button class="select-all-btn" onclick="toggleAllCheckboxes(true)">Pilih Semua</button>
    <button class="select-all-btn" onclick="toggleAllCheckboxes(false)">Hapus Semua</button>
  </div>
  <div class="checkbox-list" id="checkboxList"></div>
  <button onclick="applyCheckboxFilter()" style="background:#1877f2; color:white; margin-top:10px; text-align:center; border-radius:4px;">Terapkan Filter</button>
</div>

<button id="download">Download PDF</button>
<button id="backBtn">Kembali</button>

<script>
const SHEET_URLS = ["https://docs.google.com/spreadsheets/d/e/2PACX-1vT-PAf-G7kujpAjGhWROCvIrQ2gxn4MPjiCdbmYeowwjox00VKu2mq5cVFkgSUNg91tzJXfPHF34np7/pub?gid=126462838&single=true&output=csv"];
const MASTER_PASSWORD = "master123";
let fullData = []; 
let filteredData = []; // Data yang sedang ditampilkan
let activeColIndex = -1;

function fetchMasterLokasi() {
  fetch(SHEET_URLS[0]).then(res => res.text()).then(csv => {
    const parsed = Papa.parse(csv.trim()).data;
    const header = parsed[0];
    const iNoPel = header.indexOf('No. Pelanggan');
    if(iNoPel !== -1) {
      listLokasiMaster = [...new Set(parsed.slice(1).map(row => row[iNoPel]))].sort();
    }
  });
}
window.addEventListener('DOMContentLoaded', fetchMasterLokasi);

const inputLokasi = document.getElementById('lokasi');
const dropdown = document.getElementById('customDropdown');
inputLokasi.addEventListener('input', () => {
  const val = inputLokasi.value.toLowerCase();
  dropdown.innerHTML = "";
  if (!val) { dropdown.style.display="none"; return; }
  const matches = listLokasiMaster.filter(l => String(l).toLowerCase().includes(val));
  matches.forEach(m => {
    const li = document.createElement('li'); li.textContent = m;
    li.onclick = () => { inputLokasi.value = m; dropdown.style.display="none"; };
    dropdown.appendChild(li);
  });
  dropdown.style.display = matches.length ? "block" : "none";
});

document.getElementById('filterForm').onsubmit = (e) => {
  e.preventDefault();
  const lokasiInput = inputLokasi.value.trim().toLowerCase();
  const passVal = document.getElementById('password').value.trim();

  Promise.all(SHEET_URLS.map(url => fetch(url).then(r => r.text()))).then(csvs => {
    let combined = [];
    csvs.forEach((csv, idx) => {
      const rows = Papa.parse(csv.trim()).data;
      if(idx === 0) combined.push(rows[0]);
      combined.push(...rows.slice(1));
    });

    const header = combined[0];
    const iNoFak = header.indexOf('No. Faktur');
    const iTglFak = header.indexOf('Tgl Faktur');
    const iNoPel = header.indexOf('No. Pelanggan');
    const iNamaPel = header.indexOf('Nama Pelanggan');
    const iNilai = header.indexOf('Nilai Faktur');
    const iTerutang = header.indexOf('Terutang');
    const iTglBayar = header.indexOf('Tanggal Bayar');
    const iKet = header.indexOf('Keterangan');
    const iPass = header.indexOf('Password');
    
    // Simpan data asli sesuai urutan gambar (0 s/d 7 untuk tampilan)
    fullData = combined.slice(1).filter(r => {
      const noPel = r[iNoPel]?.trim().toLowerCase();
      const passSheet = r[iPass]?.trim();
      return noPel === lokasiInput && (passVal === MASTER_PASSWORD || passVal === passSheet);
    }).map(r => [r[iNoFak], r[iTglFak], r[iNoPel], r[iNamaPel], r[iNilai], r[iTerutang], r[iTglBayar], r[iKet]]);

    if(!fullData.length) return alert("Data tidak ditemukan atau password salah");
    
    filteredData = [...fullData];
    document.getElementById('filterForm').style.display = 'none';
    document.getElementById('hasilContainer').style.display = 'block';
    document.getElementById('download').style.display = 'block';
    document.getElementById('backBtn').style.display = 'block';
    
    renderTable(filteredData);
  });
};

function renderTable(data) {
  const body = document.getElementById('hasilBody');
  body.innerHTML = '';
  let totalN = 0, totalT = 0;
  data.forEach((r, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td>
                    <td>${r[0] || ''}</td>
                    <td>${r[1] || ''}</td>
                    <td>${r[2] || ''}</td>
                    <td>${r[3] || ''}</td>
                    <td>${r[4] || ''}</td>
                    <td>${r[5] || ''}</td>
                    <td>${r[6] || ''}</td>
                    <td>${r[7] || ''}</td>`;
    body.appendChild(tr);
    totalN += parseFloat(String(r[4]).replace(/[^0-9.-]+/g,"")) || 0;
    totalT += parseFloat(String(r[5]).replace(/[^0-9.-]+/g,"")) || 0;
  });
  document.getElementById('total').innerText = `Total Nilai Faktur: Rp ${totalN.toLocaleString('id-ID')} | Total Terutang: Rp ${totalT.toLocaleString('id-ID')}`;
}

const menu = document.getElementById('filterMenu');
const searchBox = document.getElementById('menuSearch');

document.querySelectorAll('th[data-col]').forEach(th => {
  th.onclick = (e) => {
    activeColIndex = parseInt(th.getAttribute('data-col'));
    const rect = th.getBoundingClientRect();
    menu.style.display = 'block';
    menu.style.top = (rect.bottom + window.scrollY) + 'px';
    menu.style.left = rect.left + 'px';
    
    searchBox.value = '';
    const uniqueVals = [...new Set(fullData.map(r => r[activeColIndex]))].sort();
    const list = document.getElementById('checkboxList');
    list.innerHTML = '';
    uniqueVals.forEach(v => {
      list.innerHTML += `<div class="checkbox-item"><input type="checkbox" checked value="${v}"> <span>${v}</span></div>`;
    });
    e.stopPropagation();
  };
});

function searchInMenu() {
  const filter = searchBox.value.toLowerCase();
  const items = document.querySelectorAll('.checkbox-item');
  items.forEach(item => {
    const text = item.innerText.toLowerCase();
    item.style.display = text.includes(filter) ? "flex" : "none";
  });
}

function toggleAllCheckboxes(state) {
  const checkboxes = document.querySelectorAll('#checkboxList input[type="checkbox"]');
  checkboxes.forEach(cb => {
    if (cb.parentElement.style.display !== 'none') cb.checked = state;
  });
}

function execSort(dir) {
  filteredData.sort((a, b) => {
    let valA = a[activeColIndex], valB = b[activeColIndex];
    if(!isNaN(parseFloat(String(valA).replace(/[^0-9.-]+/g,"")))) {
      valA = parseFloat(String(valA).replace(/[^0-9.-]+/g,""));
      valB = parseFloat(String(valB).replace(/[^0-9.-]+/g,""));
    }
    return dir === 'asc' ? (valA > valB ? 1 : -1) : (valA < valB ? 1 : -1);
  });
  renderTable(filteredData);
  menu.style.display = 'none';
}

function applyCheckboxFilter() {
  const checked = Array.from(document.querySelectorAll('#checkboxList input:checked')).map(i => i.value);
  filteredData = fullData.filter(r => checked.includes(String(r[activeColIndex])));
  renderTable(filteredData);
  menu.style.display = 'none';
}

document.onclick = () => menu.style.display = 'none';
menu.onclick = (e) => e.stopPropagation();
document.getElementById('backBtn').onclick = () => location.reload();

document.getElementById('download').onclick = () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('l');
  doc.text("Index AR PBC", 14, 15);
  doc.autoTable({ html: '#hasilTable', startY: 20 });
  doc.save('Index_AR_PBC.pdf');
};
</script>
</body>
</html>
