<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Scan KWh Meter</title>
  <style>
    body { font-family: sans-serif; padding:1rem; display:flex; flex-direction:column; gap:1rem; }
    video { border:1px solid #666; max-width:100%; background:#000; }
    #overlay {
      position:absolute; border:2px dashed red;
      width:260px; height:70px; left:50%; top:50%;
      transform:translate(-50%,-50%);
      pointer-events:none;
    }
    canvas { border:1px solid #ccc; max-width:100%; display:none; }
    button { padding:0.5rem 1rem; font-size:1rem; }
    #result { font-weight:bold; font-size:1.2rem; }
    .container { position:relative; display:inline-block; }
    #error { color:red; font-size:0.9rem; }
  </style>
</head>
<body>
  <h2>Scan KWh Meter (5 digit hitam)</h2>

  <div class="container">
    <video id="video" autoplay playsinline></video>
    <div id="overlay"></div>
  </div>

  <button id="scanBtn">Scan</button>
  <div id="result">Hasil: -</div>
  <div id="error"></div>
  <canvas id="canvas"></canvas>

  <!-- Tesseract.js -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>

  <script>
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const resultEl = document.getElementById('result');
    const errorEl = document.getElementById('error');

    async function startCamera(){
      errorEl.textContent = "";
      try {
        // coba kamera belakang dulu
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { exact: 'environment' } }
        });
        video.srcObject = stream;
      } catch(e1) {
        console.warn("Kamera belakang gagal:", e1.message);
        try {
          // fallback ke kamera default
          const stream = await navigator.mediaDevices.getUserMedia({ video: true });
          video.srcObject = stream;
        } catch(e2) {
          console.error("Error getUserMedia:", e2);
          errorEl.textContent = "Gagal akses kamera: " + e2.message;
        }
      }
    }

    async function scanDigits(){
      if (!video.videoWidth) { resultEl.textContent="Kamera belum siap"; return; }

      // Hitung posisi overlay relatif video
      const rect = overlay.getBoundingClientRect();
      const vrect = video.getBoundingClientRect();
      const scaleX = video.videoWidth / vrect.width;
      const scaleY = video.videoHeight / vrect.height;

      const cropX = (rect.left - vrect.left) * scaleX;
      const cropY = (rect.top - vrect.top) * scaleY;
      const cropW = rect.width * scaleX;
      const cropH = rect.height * scaleY;

      // Gambar ke canvas
      canvas.width = cropW;
      canvas.height = cropH;
      ctx.drawImage(video, cropX, cropY, cropW, cropH, 0, 0, cropW, cropH);

      resultEl.textContent = "Membaca...";

      const dataUrl = canvas.toDataURL('image/png');

      // OCR dengan whitelist angka
      const worker = Tesseract.createWorker({
        logger: m => console.log(m.status, m.progress)
      });
      await worker.load();
      await worker.loadLanguage('eng');
      await worker.initialize('eng');
      await worker.setParameters({
        tessedit_char_whitelist: '0123456789'
      });
      const { data: { text } } = await worker.recognize(dataUrl);
      await worker.terminate();

      // Ambil hanya 5 digit pertama
      let digits = (text.match(/[0-9]+/g) || []).join('');
      digits = digits.slice(0,5).padStart(5,'0');

      resultEl.textContent = "Hasil: " + (digits || "tidak terbaca");
    }

    document.getElementById('scanBtn').addEventListener('click', scanDigits);
    startCamera();
  </script>
</body>
</html>
